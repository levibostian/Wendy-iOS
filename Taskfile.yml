# To run, you must install: https://taskfile.dev/installation/

version: '3'

tasks:
  clean:
    cmds:
      - rm -rf Wendy.xcresult
      - rm -rf .build

  codegen:
    cmds:
      - ./.nest/bin/sourcery --sources Source/ --templates Source/Templates --output Source/autogenerated

  # assumes you already have nest installed
  # After this task runs, you will be able to run all CLI tools in the .nest/bin directory.
  install_dev_tools:
    cmds:
      - ./scripts/generate-nestfile.sh
      - ~/.nest/bin/nest bootstrap nestfile.yaml

  build:
    cmds:
      - task: clean 
      - task: codegen
      - pod lib lint --allow-warnings --platforms=ios
      - set -o pipefail && xcrun xcodebuild -skipMacroValidation -skipPackagePluginValidation build -scheme Wendy -destination 'generic/platform=iOS' | xcbeautify

  # to create command, get fastlane scan to run all tests, then you can copy the command it creates and run it directly. This is a small speed improvement. 
  test:
    cmds:
      - task: clean
      - task: codegen
      - set -o pipefail && xcodebuild -scheme Wendy -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' -derivedDataPath .build/derivedData -enableCodeCoverage YES build-for-testing | xcbeautify
      - set -o pipefail && xcodebuild -scheme Wendy -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' -derivedDataPath .build/derivedData -enableCodeCoverage YES test-without-building | xcbeautify
  
  # Resourced used to create this command:
  # https://github.com/michaelhenry/swifty-code-coverage/
  coverage:
    preconditions:
      - test -d .build/
    vars:
      OPTIONS: -instr-profile=$(find .build -name *.profdata | tail -n1) --ignore-filename-regex=Source/autogenerated/* --ignore-filename-regex=Tests/* --ignore-filename-regex=.build/*
      SOURCE: $(find .build -name WendyTests.xctest | tail -n1)/WendyTests
    cmds:
      - xcrun llvm-cov export {{.OPTIONS}} -format=lcov "{{.SOURCE}}" > .build/lcov.info
      - xcrun llvm-cov report {{.OPTIONS}} -use-color "{{.SOURCE}}" 
  
  lint: 
    cmds:
      - ./.nest/bin/swiftLint lint --strict
  
  format: 
    cmds:
      - ./.nest/bin/swiftFormat .
      - ./.nest/bin/swiftLint lint --fix